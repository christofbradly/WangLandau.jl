name: Benchmark (1 Thread)

on:
  pull_request:

permissions:
  pull-requests: write

jobs:
  benchmark-1thread:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.11'

      - name: Cache Julia packages
        uses: julia-actions/cache@v2

      - name: Install and build AirspeedVelocity
        shell: bash
        run: |
          export JULIA_NUM_THREADS=1
          julia -e 'ENV["JULIA_PKG_PRECOMPILE_AUTO"]=0; using Pkg; pkg"add AirspeedVelocity"'
          julia -e 'ENV["JULIA_PKG_PRECOMPILE_AUTO"]=0; import Pkg; Pkg.build("AirspeedVelocity")'

      - name: Add ~/.julia/bin to PATH
        run: echo "$HOME/.julia/bin" >> "$GITHUB_PATH"

      - name: Get package name
        id: pkg
        shell: bash
        run: |
          pkg=$(awk -F' *= *' '/^name *=/ {gsub(/"/,"",$2); print $2; exit}' Project.toml)
          echo "package_name=$pkg" >> "$GITHUB_OUTPUT"

      - name: Run benchmarks
        shell: bash
        run: |
          mkdir results
          benchpkg "${{ steps.pkg.outputs.package_name }}" \
            --url="${{ github.event.repository.clone_url }}" \
            --output-dir=results/ \
            --script=benchmark/benchmarks.jl \
            --rev="${{ github.event.repository.default_branch }},${{ github.event.pull_request.head.sha }}" \
            --bench-on="${{ github.event.repository.default_branch }}"

      - name: Create comment body
        shell: bash
        run: |
          echo "## Benchmark Results - Threads = 1" > body.md
          echo "" >> body.md
          {
            echo "<details><summary>${m^} benchmarks</summary>"
            echo ""
            benchpkgtable "${{ steps.pkg.outputs.package_name }}" \
              --input-dir=results/ \
              --mode=$m \
              --ratio \
              --rev="${{ github.event.repository.default_branch }},${{ github.event.pull_request.head.sha }}" >> body.md
            echo ""
            echo "</details>"
            echo ""
          } >> body.md

      - name: Find comment
        id: find
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: "Benchmark Results - Threads = 1"

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: body.md
          edit-mode: replace
